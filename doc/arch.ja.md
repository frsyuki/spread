SpreadOSD アーキテクチャ
========================

SpreadOSDは、高い拡張性と可用性を持った分散ストレージシステムです。
ここではそのアーキテクチャについて述べます。

## サーバの種類

SpreadOSDは、次の4種類のサーバから構成されます：

  - **DS (Data Server)** は、コンテンツをディスク上に保存したりレプリケーションしたりします。
  - **MDS (Metadata Server)** は、コンテンツのメタデータを保存します。メタデータにはコンテンツがどのDSに保存されているかを示す情報も含まれています。MDSには[Tokyo Tyrant](http://fallabs.com/tokyotyrant/)を使います。
  - **GW (Gateway)** は、アプリケーションからの要求を受け取り、適切なDSに中継します。DSはGWの機能も併せ持っているため、DSをGWとして使うこともできます。
  - **CS (Configuration Server)** は、クラスタの設定情報を管理します。また、DSの状態を監視し、故障したDSを自動的に切り離します。

**レプリケーション･セット**は、複数のDSで構成されるグループです。同じレプリケーション･セットに属するDSは、同じデータをレプリケーションして保存しています。


                        App     App     App
                         |       |       |  HTTP または MessagePack-RPC
            ----------- GW      GW      GW（またはDS）
           /            /
    +-------------+    |  GWはアプリケーションからDSにリクエストを中継
    | TokyoTyrant |    |
    |      |      |  +----+   +----+   +----+
    | TokyoTyrant |  | DS |   | DS |   | DS |
    |      |      |  |    |   |    |   |    | レプリケーション･セット
    | TokyoTyrant |  | DS |   | DS |   | DS | 同じレプリケーション･セット内のDSは同じデータを保存
    +-------------+  |    |   |    |   |    |
    MDS              | DS |   | DS |   | DS | ... レプリケーションセットはいつでも追加可能
    メタデータを保存 +----+   +----+   +----+
                         \       |       /
                          -----  |  ----- CSはクラスタの設定情報を管理
                               \ | /
                                CS


## 操作

### データの保存

GW (Gateway)（または DS (Data Server)）は、アプリケーションからの要求をMDSとDSに中継します。

MDS (Metadata Server) は「データがどこに保存されているか」を保存しており、DSは実際にデータを保存しています。

                        App     App     App
           (2)       (1) |       |       |
            ----------- GW      GW      GW
           /            /
    +-------------+    |
    |             |    | (3)
    |             |  +----+   +----+   +----+
    |     MDS     |  | DS |   | DS |   | DS |
    |             |  | | (4)  |    |   |    |
    |             |  | DS |   | DS |   | DS |
    +-------------+  | | (4)  |    |   |    |
                     | DS |   | DS |   | DS |
                     +----+   +----+   +----+

  1. アプリケーションはGWかDSに要求を送信します。どのGWやDSを選んでも構いません。
  2. GW（やDS）は、実際にデータを保存するレプリケーション･セットを選択し、そのIDをMDSに書き込みます。レプリケーション･セットの選択には、重み付きのround-robinアルゴリズムを使います。
  3. GW（やDS）は、レプリケーション･セット内のDSに追加要求を送信します。
  4. レプリケーション･セット内の他のDSは、保存されたデータをレプリケーションします。


### データの取得

MDS (Metadata Server) は、どのレプリケーション･セットに実際のデータが保存されているかを知っています。このためGW (Gatway) （やDS (Data Server) ）は、まずMDSに問い合わせ、その後データをDSから取得します。

                        App     App     App
           (2)       (1) |       |       |
            ----------- GW      GW      GW
           /            /
    +-------------+    |
    |             |    | (3)
    |             |  +----+   +----+   +----+
    |     MDS     |  | DS |   | DS |   | DS |
    |             |  |    |   |    |   |    |
    |             |  | DS |   | DS |   | DS |
    +-------------+  |    |   |    |   |    |
                     | DS |   | DS |   | DS |
                     +----+   +----+   +----+

  1. アプリケーションはGWかDSに要求を送信します。どのGWやDSを選んでも構いません。
  2. GW（またはDS）は、検索クエリをMDSに送信します。MDSは実際にデータを保存しているレプリケーション･セットのIDを返します。
  3. GW（またはDS）は、そのレプリケーション･セット内のDSに対して取得要求を送信します。DSは位置を考慮したアルゴリズムによって選択されます。（TODO: See HowTo Geo-redundancy）


### 属性の保存と取得

属性は MDS (Metadata Server) に保存されています。

                        App     App     App
           (2)       (1) |       |       |
            ----------- GW      GW      GW
           /
    +-------------+
    |             |
    |             |  +----+   +----+   +----+
    |     MDS     |  | DS |   | DS |   | DS |
    |             |  | |  |   |    |   |    |
    |             |  | DS |   | DS |   | DS |
    +-------------+  | |  |   |    |   |    |
                     | DS |   | DS |   | DS |
                     +----+   +----+   +----+

  1. アプリケーションはGWかDSに要求を送信します。どのGWやDSを選んでも構いません。
  2. GW（DS）は、クエリをMDSに送信します。


## 管理と監視

すべての DS (Data Server) は CS (Configuration Server) に登録されています。管理ツールや監視ツールは、CSの設定を書き換えたり、CSからサーバの一覧表を取得することで、すべてのDSを一斉に制御します。

                     (1)      (2)
      Administrator --> ツール --> CS
                         / \
    +-------------+     |   -------------  (3)
    |             |     |       |        \
    |             |  +----+   +----+   +----+
    |     MDS     |  | DS |   | DS |   | DS |
    |             |  | |  |   |    |   |    |
    |             |  | DS |   | DS |   | DS |
    +-------------+  | |  |   |    |   |    |
                     | DS |   | DS |   | DS |
                     +----+   +----+   +----+

  1. 管理者（あなた）が管理ツールを実行します。
  2. 管理ツールは、CSからクラスタの情報を取得します。
  3. 管理ツールは、状態や統計情報をDSから取得して表示します。

次のステップ：[運用](operation.ja.md)

